rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email));
    }

    function isMe(userId) {
      return isAuth() &&
             request.auth.token.email == userId;
    }

    function isRequestForMe() {
      return isAuth() &&
             request.auth.token.email == resource.data.current_approver_email;
    }

    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }

    match /departments/{departmentId} {
      allow read, write: if isAdmin();
    }

    // 自分の申請に対するルール
    match /users/{userId} {
      allow read, write: if isMe(userId);

      match /requests/{requestId}/{doc=**} {
        allow read, create: if isMe(userId);
      }
    }

    // 承認依頼に対するルール 一覧画面
    match /{path=**}/requests/{requestId} {
      allow list: if isRequestForMe();
    }

    // 承認依頼に対するルール 詳細画面
    match /{path=**}/details/{detailId} {
      allow list, update: if isRequestForMe();
    }

    match /routes/{routeId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
  }
}
